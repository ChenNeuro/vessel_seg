# 冠状动脉拓扑建模：我们在做什么、数学原理与预期结果

## 1. 我们在做什么
- 用中心线（VTP）构建冠状动脉树拓扑，并输出可分析的树结构数据集。
- 解决中心线**起点重合**问题：对父子重合段进行裁剪（trim），再重建树，得到更真实的分支连接位置。
- 统计 20 例 Normal 的拓扑结构频率与相似性，并生成可视化（2D/3D）。
- 为后续分割/重建提供**拓扑先验**（结构约束）。

## 2. 数学原理（核心步骤）

### 2.1 树构建（父子关系、lambda、角度）
每条分支中心线记为多段折线 `B_i = {x_k}`。

**父子关系**：  
对每个子分支起点 `p`，在候选父分支折线上做投影，找最小距离点：
```
s_star = argmin_s || p - proj_parent(s) ||
```
若最小距离 `d <= T`（阈值，单位 mm），则建立父子连接。

**位置参数**（沿父支的相对位置）：
```
lambda = s_star / L_parent,  lambda in [0, 1]
```

**方向角**：  
父支在投影点的切向 `T`，子支起始方向 `v`。  
```
theta = arccos( (T dot v) / (|T| * |v|) )
```
在法-副法平面构造正交基 `(N, B)`，投影后：
```
phi = atan2( v dot B, v dot N )
```

### 2.2 去重（裁剪重合前缀）
原始 VTP 中不同分支常**共享起点/前缀**。  
对每个子分支点 `c_k`，计算到父分支的最短距离 `d_k`。  
若连续若干点满足 `d_k <= eps`，则裁剪这段前缀，保留真正分叉后的部分。
裁剪后再**重建树**，得到更合理的 `lambda/theta/phi`。

### 2.3 左右系统划分（基于 GT 根位置）
左右根不再按长度，而按**原始 GT 根的空间相对位置**划分：  
1) 将裁剪后根映射到最近的 GT 根。  
2) 选取 GT 两根最大分离轴，按坐标排序得到左/右。

### 2.4 层级与拓扑统计
- **层级深度**：沿 parent 链追溯，depth(root)=0。  
- **分支顺序**：同一父节点内按 `lambda` 从小到大排序（出现先后）。  
- **根到叶路径结构**：以“分叉度序列”编码路径，并用多重集 Jaccard 评估相似度。

## 3. 预期结果（“应该长什么样”）
- **每例**得到清晰的左右系统树：  
  - 左系统分支更丰富，常见 2–4 个一级分支，并带少量二级分叉。  
  - 右系统更接近“主干+少量侧支”，分支数通常更少。  
- **拓扑平均结构**稳定：双根、浅层树（2–3 层为主）。  
- **`lambda/theta/phi`** 不再全为 0，可用于统计或先验建模。  
- **可视化**能同时呈现：  
  - 2D 拓扑（层级与顺序）  
  - 3D 空间走向（真实中心线投影）

## 4. 主要输出（当前项目）
- 去重树：`outputs/Normal_*/tree_trim_overlap0.json`
- 拓扑数据集：`outputs/topology_dataset_all_trim_overlap0_tree/`
- 结构频率/相似性：`topology_structure_patterns.*`、`topology_root_to_leaf_similarity_*`
- 3D 结构图：`topology_cases_grid_3d_*.png`

## 5. 限制与注意
- 依赖中心线质量；若中心线起点或分支错误，会影响拓扑。  
- `lambda/theta/phi` 与裁剪阈值有关，需要固定规则。  
- 2D 树图只表达拓扑，不表达真实空间形态；3D 图才反映走向。  
